apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: cleanup-trigger
spec:
  schedule: "0 12 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
          - name: workspace
            emptyDir: {}
          containers:
          - name: trigger
            image: curlimages/curl
            command:
              - /bin/sh
            args:
              - -ce
              - |
                cat <<EOF > /workspace/post-body.json
                {
                  "trigger-template": "cleanup",
                  "params": {
                    "target": {
                      "namespace": "$NAMESPACE"
                    },
                    "cleanup": {
                      "keep": "$CLEANUP_KEEP"
                    }, 
                    "auth": {
                      "filename:" $FILENAME
                      "name": "$NAME",
                      "url": "$URL",
                      "cadata": "$CA_DATA",
                      "clientKeyData": "$CLIENT_KEY_DATA",
                      "clientCertificateData: "$CLIENT_CERTIFICATE_DATA"
                    }
                  }
                }
                EOF
                curl -d @/workspace/post-body.json $SINK_URL
            volumeMounts:
            - mountPath: /workspace
              name: workspace
            env:
              - name: URL
                value: https://api.ci-ln-...
              - name: NAMESPACE
                value: default
              - name: FILENAME
                value: kubeconfig
              - name: CLEANUP_KEEP
                value: "5"
              - name: NAME 
                value: cluster-bot
              - name: CA_DATA
                value: LS0tLS... 
              - name: CLIENT_KEY_DATA
                value: LS0tLS...
              - name: CLIENT_CERTIFICATE_DATA
                value: LS0tLS...
          restartPolicy: Never